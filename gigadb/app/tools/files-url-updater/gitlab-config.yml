
b_urls_updater:
  variables:
    LOCAL_COMPOSE: "docker-compose -f ./docker-compose.yml -f ./docker-compose.ci.yml"

  stage: build for test
  script:
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/updater:latest || true
    - cd gigadb/app/tools/files-url-updater
    - $LOCAL_COMPOSE build updater
    - docker tag ${CI_PROJECT_NAME}_updater:latest registry.gitlab.com/$CI_PROJECT_PATH/updater:latest
    - docker push registry.gitlab.com/$CI_PROJECT_PATH/updater:latest

t_urls_updater:
  variables:
    LOCAL_COMPOSE: "docker-compose -f ./docker-compose.yml -f ./docker-compose.ci.yml"
    GIGADB_HOST: "172.17.0.1"
    GIGADB_PASSWORD: ""

  stage: test
  artifacts:
    paths:
      - gigadb/app/tools/files-url-updater/runtime/logs/app.log
      - gigadb/app/tools/files-url-updater/tests/_output
      - gigadb/app/tools/files-url-updater/drop_restore.log
      - gigadb/app/tools/files-url-updater/config/params.php
      - gigadb/app/tools/files-url-updater/composer.json
      - gigadb/app/tools/files-url-updater/composer.lock
      - gigadb/app/tools/files-url-updater/tests/acceptance.suite.yml
      - gigadb/app/tools/files-url-updater/tests/ci.acceptance.suite.yml
      - .env
      - .secrets
      - protected/config/db.json
    when: always
    expire_in: 1 week
  script:
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/updater:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/application:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/test:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/console:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/web:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/ftpd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/watcher:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/tusd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/beanstalkd:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/web:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/js:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-admin:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/gigadb-worker:latest || true
    - docker pull registry.gitlab.com/$CI_PROJECT_PATH/fuw-public:latest || true
    - cd gigadb/app/tools/files-url-updater
    - $LOCAL_COMPOSE run --rm updater composer install
    - $LOCAL_COMPOSE up -d pg9_3
    - cd $APPLICATION
    - ./up.sh
    - cd gigadb/app/tools/files-url-updater
    - echo yes | $LOCAL_COMPOSE run --rm updater ./yii dataset-files/download-restore-backup --default
    - cp tests/ci.acceptance.suite.yml tests/acceptance.suite.yml
    - ls -lart tests/
    - $LOCAL_COMPOSE run --rm updater ./vendor/bin/codecept build
    - $LOCAL_COMPOSE run --rm updater ./vendor/bin/codecept run
  dependencies:
    - b_urls_updater