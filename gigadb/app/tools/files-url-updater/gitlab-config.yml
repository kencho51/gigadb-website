test_files_url_updater:
  variables:
    LOCAL_COMPOSE: "docker-compose -f ./docker-compose.yml"
    GIGADB_HOST: "172.17.0.1"
    GIGADB_PASSWORD: ""

  stage: test
  artifacts:
    paths:
      - gigadb/app/tools/files-url-updater/runtime/logs/app.log
      - gigadb/app/tools/files-url-updater/tests/_output
      - gigadb/app/tools/files-url-updater/drop_restore.log
      - gigadb/app/tools/files-url-updater/config/params.php
      - gigadb/app/tools/files-url-updater/composer.json
      - gigadb/app/tools/files-url-updater/composer.lock
    when: always
    expire_in: 1 week
  script:
    - cd gigadb/app/tools/files-url-updater
    - $LOCAL_COMPOSE run --rm updater composer install
    - $LOCAL_COMPOSE up -d pg9_3
    - echo yes | $LOCAL_COMPOSE run --rm updater ./yii dataset-files/download-restore-backup --default
    - cd $APPLICATION
    - ./up.sh
    - cd gigadb/app/tools/files-url-updater
    - $LOCAL_COMPOSE run --rm updater ./vendor/bin/codecept build
    - $LOCAL_COMPOSE run --rm updater ./vendor/bin/codecept run
  dependencies:
    - test_build